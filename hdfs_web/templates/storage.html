{% extends "layout.html" %}

{% block title %}Qu·∫£n l√Ω L∆∞u tr·ªØ{% endblock %}
{% block header %}üìÅ Tr√¨nh duy·ªát HDFS{% endblock %}

{% block content %}
<div class="breadcrumbs">
    {% for crumb in breadcrumbs %}
    <a href="/browse{{ crumb.path }}">{{ crumb.name }}</a>
    {% if not loop.last %} / {% endif %}
    {% endfor %}
</div>

<!-- Container cho c√°c th√¥ng b√°o chung -->
<div id="messageContainer"
    style="margin-bottom: 15px; padding: 10px; border-radius: 5px; display: none; font-weight: bold;"></div>

<table>
    <tr>
        <th>T√™n</th>
        <th>Lo·∫°i</th>
        <th>H√†nh ƒë·ªông</th>
    </tr>
    {% for entry in entries %}
    <tr>
        <td>
            {% if entry.type == 'directory' %}
            <a href="/browse{{ entry.path }}">{{ entry.name }}</a>
            {% else %}
            {{ entry.name }}
            {% endif %}
        </td>
        <td>{{ entry.type }}</td>
        <td>
            {% if entry.name != '...' %}
            {% if entry.type == 'file' %}
            <a href="/download{{ entry.path }}" style="margin-right: 10px;">‚¨áÔ∏è Download</a>
            {% elif entry.type == 'directory' %}
            <!-- N√∫t T·∫£i ZIP M·ªöI -->
            <a href="/download_zip{{ entry.path }}"
                style="background-color: #ffc107; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                üì¶ T·∫£i ZIP
            </a>
            {% endif %}

            <!-- N√∫t X√≥a -->
            <button onclick="showDeleteConfirmation('{{ entry.path }}', '{{ entry.name }}', '{{ entry.type }}')"
                style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">
                üóëÔ∏è X√≥a
            </button>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

<div style="display: flex; gap: 20px; margin-top: 20px;">

    <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 1;">
        <h3>‚¨ÜÔ∏è T·∫£i file l√™n th∆∞ m·ª•c hi·ªán t·∫°i: `{{ current_path }}`</h3>
        <form id="simpleUploadForm" action="/upload" method="POST" enctype="multipart/form-data">
            <!-- Cho ph√©p ch·ªçn nhi·ªÅu file -->
            <input type="file" name="file" multiple required>
            <button type="submit"
                style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                Upload File
            </button>
        </form>
        <p id="uploadStatus"></p>
    </div>

    <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 1;">
        <h3>‚ûï T·∫°o th∆∞ m·ª•c m·ªõi trong `{{ current_path }}`</h3>
        <form id="createDirForm">
            <input type="text" name="dir_name" placeholder="T√™n th∆∞ m·ª•c m·ªõi" required
                style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            <button type="submit"
                style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">T·∫°o
                Th∆∞ m·ª•c</button>
        </form>
        <p id="dirStatus"></p>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n x√≥a t√πy ch·ªânh (Thay th·∫ø cho window.confirm) -->
<div id="deleteConfirmationModal"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100;">
    <div
        style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%;">
        <h4 style="margin-top: 0;">X√°c nh·∫≠n X√≥a</h4>
        <p id="confirmationText"></p>
        <div style="text-align: right; margin-top: 20px;">
            <button id="cancelDeleteBtn"
                style="background-color: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">H·ªßy
                b·ªè</button>
            <button id="confirmDeleteBtn"
                style="background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">X√≥a</button>
        </div>
    </div>
</div>

<script>
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o chung (success/error)
    function showMessage(message, isError = false) {
        const container = $('#messageContainer');
        container.text(message);
        container.css('display', 'block');
        if (isError) {
            container.css('background-color', '#f8d7da');
            container.css('color', '#721c24');
            container.css('border', '1px solid #f5c6cb');
        } else {
            container.css('background-color', '#d4edda');
            container.css('color', '#155724');
            container.css('border', '1px solid #c3e6cb');
        }
        setTimeout(() => {
            container.fadeOut(500);
        }, 5000);
    }

    let currentDeletePath = '';
    let currentDeleteType = '';

    // Hi·ªÉn th·ªã modal x√°c nh·∫≠n (Thay th·∫ø cho window.confirm)
    function showDeleteConfirmation(path, name, type) {
        currentDeletePath = path;
        currentDeleteType = type;

        const typeText = type === 'file' ? 't·ªáp' : 'th∆∞ m·ª•c';
        let message = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${typeText} <span style="font-style: italic;">"${name}"</span> kh√¥ng?`;

        if (type === 'directory') {
            message += ' <br>(L∆ØU √ù: Th∆∞ m·ª•c v√† T·∫§T C·∫¢ n·ªôi dung b√™n trong s·∫Ω b·ªã x√≥a.)';
        }

        $('#confirmationText').html(message);
        $('#deleteConfirmationModal').fadeIn(300);
    }

    // X·ª≠ l√Ω logic x√≥a file/th∆∞ m·ª•c
    function deleteHDFS() {
        $('#deleteConfirmationModal').fadeOut(300); // ƒê√≥ng modal ngay l·∫≠p t·ª©c
        const path = currentDeletePath;

        $.ajax({
            url: `/delete${path}`,
            type: 'DELETE',
            success: function (response) {
                showMessage(response.message || 'X√≥a th√†nh c√¥ng!', false);
                setTimeout(() => {
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
                }, 1000);
            },
            error: function (xhr, status, error) {
                var msg = xhr.responseJSON ? xhr.responseJSON.message : (error + " (Ki·ªÉm tra console)");
                showMessage('X√≥a th·∫•t b·∫°i. L·ªói: ' + msg, true);
                console.error("Delete error:", xhr.responseText);
            }
        });
    }

    $(document).ready(function () {
        // G√°n s·ª± ki·ªán cho n√∫t X√°c nh·∫≠n trong Modal
        $('#confirmDeleteBtn').on('click', deleteHDFS);
        // G√°n s·ª± ki·ªán cho n√∫t H·ªßy trong Modal
        $('#cancelDeleteBtn').on('click', function () {
            $('#deleteConfirmationModal').fadeOut(300);
        });


        // LOGIC UPLOAD
        // LOGIC UPLOAD (h·ªó tr·ª£ nhi·ªÅu file)
        $('#simpleUploadForm').on('submit', function (e) {
            e.preventDefault();
            var form = $(this);
            var formData = new FormData(form[0]);
            formData.append('path', '{{ current_path }}');

            var filesCount = form.find('input[type="file"]')[0].files.length;
            if (filesCount === 0) {
                showMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file ƒë·ªÉ upload!', true);
                return;
            }

            $('#uploadStatus').html(`<span style="color: blue;">ƒêang t·∫£i l√™n ${filesCount} file...</span>`);

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    $('#uploadStatus').text('');
                    if (response.uploaded_files && response.uploaded_files.length) {
                        showMessage(`‚úÖ Upload th√†nh c√¥ng ${response.uploaded_files.length} file!`, false);
                    } else {
                        showMessage(response.message || 'Upload th√†nh c√¥ng!', false);
                    }
                    setTimeout(() => location.reload(), 1200);
                },
                error: function (xhr, status, error) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : (error + " (Ki·ªÉm tra console)");
                    $('#uploadStatus').html('<span style="color: red;">L·ªói upload: ' + msg + '</span>');
                    console.error("Upload error:", xhr.responseText);
                }
            });
        });


        // LOGIC T·∫†O TH∆Ø M·ª§C
        $('#createDirForm').on('submit', function (e) {
            e.preventDefault();
            var form = $(this);
            var dirName = form.find('input[name="dir_name"]').val();
            var postData = {
                dir_name: dirName,
                current_path: '{{ current_path }}'
            };
            $('#dirStatus').html('<span style="color: blue;">ƒêang t·∫°o th∆∞ m·ª•c...</span>');

            $.ajax({
                url: '/mkdir',
                type: 'POST',
                data: postData,
                success: function (response) {
                    $('#dirStatus').text(''); // Clear local status
                    showMessage(response.message || 'T·∫°o th∆∞ m·ª•c th√†nh c√¥ng!', false);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                },
                error: function (xhr, status, error) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : (error + " (Ki·ªÉm tra console)");
                    $('#dirStatus').html('<span style="color: red;">L·ªói t·∫°o th∆∞ m·ª•c: ' + msg + '</span>');
                    console.error("Mkdir error:", xhr.responseText);
                }
            });
        });
    });
</script>


{% endblock %}