<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>HDFS Browser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
</head>
<body>
    <h1>üìÅ Tr√¨nh duy·ªát HDFS</h1>

    <div class="breadcrumbs">
        {% for crumb in breadcrumbs %}
            <a href="/browse{{ crumb.path }}">{{ crumb.name }}</a>
            {% if not loop.last %} / {% endif %}
        {% endfor %}
    </div>

    <table>
        <tr><th>T√™n</th><th>Lo·∫°i</th><th>H√†nh ƒë·ªông</th></tr>
        {% for entry in entries %}
        <tr>
            <td>
                {% if entry.type == 'directory' %}
                    <a href="/browse{{ entry.path }}">{{ entry.name }}</a>
                {% else %}
                    {{ entry.name }}
                {% endif %}
            </td>
            <td>{{ entry.type }}</td>
            <td>
                {% if entry.type == 'file' %}
                    <a href="/download{{ entry.path }}">‚¨áÔ∏è Download</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>

    <div style="display: flex; gap: 20px; margin-top: 20px;">
        
        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 1;">
            <h3>‚¨ÜÔ∏è T·∫£i file l√™n th∆∞ m·ª•c hi·ªán t·∫°i: `{{ current_path }}`</h3>
            <form id="simpleUploadForm" action="/upload" method="POST" enctype="multipart/form-data">
                <input type="file" name="file" required>
                <button type="submit">Upload File</button>
            </form>
            <p id="uploadStatus"></p>
        </div>

        <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; flex: 1;">
            <h3>‚ûï T·∫°o th∆∞ m·ª•c m·ªõi trong `{{ current_path }}`</h3>
            <form id="createDirForm">
                <input type="text" name="dir_name" placeholder="T√™n th∆∞ m·ª•c m·ªõi" required>
                <button type="submit">T·∫°o Th∆∞ m·ª•c</button>
            </form>
            <p id="dirStatus"></p>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            // LOGIC UPLOAD (Gi·ªØ nguy√™n v√† c·∫£i ti·∫øn ph·∫ßn th√¥ng b√°o l·ªói)
            $('#simpleUploadForm').on('submit', function(e) {
                e.preventDefault(); 
                
                var form = $(this);
                var formData = new FormData(form[0]);
                
                // Th√™m ƒë∆∞·ªùng d·∫´n hi·ªán t·∫°i v√†o FormData
                formData.append('path', '{{ current_path }}');

                $('#uploadStatus').text('ƒêang t·∫£i l√™n...');

                // Th·ª±c hi·ªán upload b·∫±ng AJAX
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false, 
                    contentType: false, 
                    success: function(response) {
                        $('#uploadStatus').text(response.message || 'Upload th√†nh c√¥ng!');
                        location.reload(); 
                    },
                    error: function(xhr, status, error) {
                        var msg = xhr.responseJSON ? xhr.responseJSON.message : (error + " (Ki·ªÉm tra console)");
                        $('#uploadStatus').text('L·ªói upload: ' + msg);
                        console.error("Upload error:", xhr.responseText);
                    }
                });
            });

            // LOGIC M·ªöI: T·∫°o th∆∞ m·ª•c
            $('#createDirForm').on('submit', function(e) {
                e.preventDefault(); 
                
                var form = $(this);
                var dirName = form.find('input[name="dir_name"]').val();
                
                var postData = {
                    dir_name: dirName,
                    current_path: '{{ current_path }}' // ƒê∆∞·ªùng d·∫´n hi·ªán t·∫°i ƒë·ªÉ t·∫°o th∆∞ m·ª•c
                };

                $('#dirStatus').text('ƒêang t·∫°o th∆∞ m·ª•c...');

                // Th·ª±c hi·ªán t·∫°o th∆∞ m·ª•c b·∫±ng AJAX
                $.ajax({
                    url: '/mkdir',
                    type: 'POST',
                    data: postData,
                    success: function(response) {
                        $('#dirStatus').text(response.message || 'T·∫°o th∆∞ m·ª•c th√†nh c√¥ng!');
                        location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ th·∫•y th∆∞ m·ª•c m·ªõi
                    },
                    error: function(xhr, status, error) {
                        var msg = xhr.responseJSON ? xhr.responseJSON.message : (error + " (Ki·ªÉm tra console)");
                        $('#dirStatus').text('L·ªói t·∫°o th∆∞ m·ª•c: ' + msg);
                        console.error("Mkdir error:", xhr.responseText);
                    }
                });
            });
        });
    </script>
</body>
</html>